rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user has admin role via custom claims
     */
    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }

    /**
     * @description Check if user has admin role in their user document
     * NOTE: This requires a document read and is less efficient than custom claims
     * Returns false if document doesn't exist instead of erroring
     */
    function isAdminViaDoc() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Rules for user documents.
     * Admins can list all users and manage any user profile.
     * Regular users can only access their own profile.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdminViaDoc();
      allow list: if isAdminViaDoc();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) || isAdminViaDoc();
      allow delete: if isOwner(userId) || isAdminViaDoc();
    }

    /**
     * @description Rules for task documents. Tasks are publicly readable, but writes are restricted.
     * Admins or the task creator can modify them.
     * @path /tasks/{taskId}
     */
    match /tasks/{taskId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.created_by == request.auth.uid;
      allow update: if isSignedIn() && (resource.data.created_by == request.auth.uid || isAdminViaDoc());
      allow delete: if isSignedIn() && (resource.data.created_by == request.auth.uid || isAdminViaDoc());
    }

    /**
     * @description Rules for client documents. Clients are readable by authenticated users.
     * Only admins can manage client documents.
     * @path /clients/{clientId}
     */
    match /clients/{clientId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdminViaDoc();
      allow update: if isAdminViaDoc();
      allow delete: if isAdminViaDoc();
    }

    /**
     * @description Rules for file documents associated with a task.
     * @path /tasks/{taskId}/files/{fileId}
     */
    match /tasks/{taskId}/files/{fileId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn(); // Further validation may be needed here based on task assignment
      allow update: if false; // TODO: Add stricter rules.
      allow delete: if false; // TODO: Add stricter rules.
    }

    /**
     * @description Rules for attendance documents. Attendance records are readable by authenticated users.
     * Users can create their own attendance records. Only the owner or admin can modify/delete.
     * @path /attendance/{attendanceId}
     */
    match /attendance/{attendanceId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdminViaDoc());
        allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdminViaDoc());
    }

    /**
     * @description Rules for course documents. Course documents are readable by authenticated users.
     * Users can create their own course assignments. Only the assigned user or admin can modify/delete.
     * @path /courses/{courseId}
     */
    match /courses/{courseId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn() && (request.resource.data.userId == request.auth.uid || isAdminViaDoc());
        allow update: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdminViaDoc());
        allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdminViaDoc());
    }

    /**
     * @description Rules for chat messages. Chat messages are readable by authenticated users.
     * Any signed-in user can create a message with their own userId. Messages are immutable.
     * @path /chat/{messageId}
     */
    match /chat/{messageId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Rules for leave requests. Users can manage their own leaves, admins can manage all.
     * @path /leaves/{leaveId}
     */
    match /leaves/{leaveId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn() && (request.resource.data.userId == request.auth.uid || isAdminViaDoc());
        allow update: if isSignedIn() && ((resource.data.userId == request.auth.uid && resource.data.status == 'pending') || isAdminViaDoc());
        allow delete: if isSignedIn() && ((resource.data.userId == request.auth.uid && resource.data.status == 'pending') || isAdminViaDoc());
    }

    /**
     * @description Rules for deductions. Only admins can create deductions, users can view their own.
     * @path /deductions/{deductionId}
     */
    match /deductions/{deductionId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isAdminViaDoc();
        allow update: if isAdminViaDoc();
        allow delete: if isAdminViaDoc();
    }
  }
}
