/**
 * @description This ruleset enforces a strict user-ownership model for user profiles and tasks.
 *  It allows public read access to tasks but restricts write access to owners and requires authentication for all operations.
 *  It restricts listing of all users due to privacy concerns.
 * @dataStructure
 *  - /users/{userId}: Stores user profiles, accessible only to the user themselves.
 *  - /tasks/{taskId}: Stores task details. Publicly readable, but only the creator can modify.
 *  - /tasks/{taskId}/files/{fileId}: Stores files associated with tasks, accessible only by the uploader.
 * @keySecurityDecisions
 *  - Listing all users is explicitly denied to prevent information disclosure.
 *  - Public read access to tasks allows for open dashboards, but writes are strictly controlled by ownership.
 * @denormalizationForAuthorization
 *  - Task documents should contain a `createdBy` field to indicate the owner.  This is validated on creation and used for authorization on updates and deletes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profiles, allowing only the owner to read and write their own data.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile if the userId matches their auth.uid.
     * @allow (get, update, delete) - Authenticated user can access their own profile if the userId matches their auth.uid.
     * @deny (create) - If the userId does not match the authenticated user's ID.
     * @deny (get, update, delete) - If the userId does not match the authenticated user's ID.
     * @deny (list) - Listing all users is not permitted.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId} {
      // Verify identity
      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the uid is the same as the user id in the document
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Only the user can create their profile, and the ID must match their auth.uid
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == request.auth.uid;

      // Only the user can read their profile
      allow get: if isSignedIn() && isOwner(userId);

      // Only the user can update their profile, and the ID must match their auth.uid
      allow update: if isSignedIn() && isOwner(userId) && resource.data.id == request.resource.data.id;

      // Only the user can delete their profile
      allow delete: if isSignedIn() && isOwner(userId);

      // Listing all users is not permitted
      allow list: if false;
    }

    /**
     * @description Manages tasks, allowing public read access but restricting write access to the task creator.
     * @path /tasks/{taskId}
     * @allow (get, list) - Everyone can read tasks.
     * @allow (create) - Authenticated user can create a task, and the createdBy field must match their auth.uid.
     * @allow (update, delete) - Only the creator of the task can modify or delete it.
     * @deny (create) - If the createdBy field does not match the authenticated user's ID.
     * @deny (update, delete) - If the user is not the creator of the task.
     * @principle Allows public read access while enforcing document ownership for writes.
     */
    match /tasks/{taskId} {
      // Verify identity
      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the user is the owner of the task
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      //Check if the user is the existing owner of the task
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Everyone can read tasks
      allow get, list: if true;

      // Only signed-in users can create tasks, and the createdBy field must match their auth.uid
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;

      // Only the owner can update or delete the task
      allow update: if isExistingOwner(resource.data.createdBy) && resource.data.createdBy == request.resource.data.createdBy;
      allow delete: if isExistingOwner(resource.data.createdBy);
    }

    /**
     * @description Secures files associated with tasks, allowing only the uploader to manage their own files.
     * @path /tasks/{taskId}/files/{fileId}
     * @allow (create) - Authenticated user can create a file if the uploadedBy field matches their auth.uid.
     * @allow (get, list, update, delete) - Only the user who uploaded the file can access or modify it.
     * @deny (create) - If the uploadedBy field does not match the authenticated user's ID.
     * @deny (get, list, update, delete) - If the user is not the uploader of the file.
     * @principle Enforces document ownership for writes and restricts access to the uploader.
     */
    match /tasks/{taskId}/files/{fileId} {
      // Verify identity
      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the user is the owner of the file
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      //Check if the user is the existing owner of the file
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Only signed-in users can create files, and the uploadedBy field must match their auth.uid
      allow create: if isSignedIn() && request.resource.data.uploadedBy == request.auth.uid;

      // Only the owner can read, update, or delete the file
      allow get, list: if isExistingOwner(resource.data.uploadedBy);
      allow update: if isExistingOwner(resource.data.uploadedBy) && resource.data.uploadedBy == request.resource.data.uploadedBy;
      allow delete: if isExistingOwner(resource.data.uploadedBy);
    }
  }
}