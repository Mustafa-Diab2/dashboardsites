rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the existing document.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user documents.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own document.
     *   Request: { "auth": { "uid": "user123" }, "resource": { "data": { "id": "user123", ... } } }
     * @allow (get) User with ID 'user123' can read their own document.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (update) User with ID 'user123' can update their own document.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny  (create) User with ID 'user123' cannot create a document with a different ID ('user456').
     *   Request: { "auth": { "uid": "user123" }, "resource": { "data": { "id": "user456", ... } } }
     * @deny (update) User with ID 'user123' cannot update someone else's document ('user456').
     *   Request: { "auth": { "uid": "user123" }, "resource": { "data": { "id": "user456", ... } } }
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for task documents. Tasks are publicly readable, but writes are restricted to the task creator.
     * @path /tasks/{taskId}
     * @allow (get) Any user can read a task.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (list) Any user can list tasks.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (create) User with ID 'user123' can create a task with 'created_by' field set to 'user123'.
     *   Request: { "auth": { "uid": "user123" }, "resource": { "data": { "created_by": "user123", ... } } }
     * @deny  (create) User with ID 'user123' cannot create a task with 'created_by' field set to a different user ID ('user456').
     *   Request: { "auth": { "uid": "user123" }, "resource": { "data": { "created_by": "user456", ... } } }
     * @deny (update) User with ID 'user123' cannot update a task if they are not the creator (resource.data.created_by != 'user123').
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (delete) User with ID 'user123' cannot delete a task if they are not the creator (resource.data.created_by != 'user123').
     *   Request: { "auth": { "uid": "user123" } }
     * @principle Tasks are publicly readable, but only the creator can modify them.
     */
    match /tasks/{taskId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.created_by == request.auth.uid;
      allow update: if isSignedIn() && resource.data.created_by == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.created_by == request.auth.uid;
    }

    /**
     * @description Rules for client documents. Clients are publicly readable, but writes are restricted.
     * @path /clients/{clientId}
     * @allow (get) Any user can read a client document.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (list) Any user can list client documents.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (create) No general create rule.  Writes must be specifically granted based on application logic.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (update) No general update rule.  Writes must be specifically granted based on application logic.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (delete) No general delete rule.  Writes must be specifically granted based on application logic.
     *   Request: { "auth": { "uid": "user123" } }
     * @principle Clients are publicly readable, but write permissions are restricted.
     */
    match /clients/{clientId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add stricter rules.
      allow update: if false; // TODO: Add stricter rules.
      allow delete: if false; // TODO: Add stricter rules.
    }

    /**
     * @description Rules for file documents associated with a task.
     * @path /tasks/{taskId}/files/{fileId}
     * @allow (get) Any user can read a file.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (list) Any user can list files.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (create) User can create a file if signed in. Additional checks might be required based on task assignment.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (update) No general update rule. Writes must be specifically granted based on application logic.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (delete) No general delete rule. Writes must be specifically granted based on application logic.
     *   Request: { "auth": { "uid": "user123" } }
     * @principle Files are publicly readable, but write permissions are restricted.
     */
    match /tasks/{taskId}/files/{fileId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn(); // Further validation may be needed here based on task assignment
      allow update: if false; // TODO: Add stricter rules.
      allow delete: if false; // TODO: Add stricter rules.
    }

      /**
       * @description Rules for attendance documents. Attendance records are publicly readable.
       * @path /attendance/{attendanceId}
       * @allow (get) Any user can read attendance records.
       * Request: { "auth": { "uid": "user123" } }
       * @allow (list) Any user can list attendance records.
       * Request: { "auth": { "uid": "user123" } }
       * @deny (create) No general create rule.  Writes must be specifically granted based on application logic.
       *   Request: { "auth": { "uid": "user123" } }
       * @deny (update) No general update rule.  Writes must be specifically granted based on application logic.
       *   Request: { "auth": { "uid": "user123" } }
       * @deny (delete) No general delete rule.  Writes must be specifically granted based on application logic.
       *   Request: { "auth": { "uid": "user123" } }
       * @principle Attendance records are publicly readable, but write permissions are restricted.
       */
    match /attendance/{attendanceId} {
        allow get: if true;
        allow list: if true;
        allow create: if false; // TODO: Add stricter rules.
        allow update: if false; // TODO: Add stricter rules.
        allow delete: if false; // TODO: Add stricter rules.
    }

      /**
       * @description Rules for course documents. Course documents are publicly readable.
       * @path /courses/{courseId}
       * @allow (get) Any user can read course documents.
       * Request: { "auth": { "uid": "user123" } }
       * @allow (list) Any user can list course documents.
       * Request: { "auth": { "uid": "user123" } }
       * @deny (create) No general create rule.  Writes must be specifically granted based on application logic.
       *   Request: { "auth": { "uid": "user123" } }
       * @deny (update) No general update rule.  Writes must be specifically granted based on application logic.
       *   Request: { "auth": { "uid": "user123" } }
       * @deny (delete) No general delete rule.  Writes must be specifically granted based on application logic.
       *   Request: { "auth": { "uid": "user123" } }
       * @principle Course documents are publicly readable, but write permissions are restricted.
       */
    match /courses/{courseId} {
        allow get: if true;
        allow list: if true;
        allow create: if false; // TODO: Add stricter rules.
        allow update: if false; // TODO: Add stricter rules.
        allow delete: if false; // TODO: Add stricter rules.
    }

    /**
     * @description Rules for chat messages. Chat messages are publicly readable.
     * @path /chat/{messageId}
     * @allow (get) Any user can read chat messages.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (list) Any user can list chat messages.
     *   Request: { "auth": { "uid": "user123" } }
     * @allow (create) Any signed-in user can create a chat message.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (update) No general update rule.  Writes must be specifically granted based on application logic.
     *   Request: { "auth": { "uid": "user123" } }
     * @deny (delete) No general delete rule.  Writes must be specifically granted based on application logic.
     *   Request: { "auth": { "uid": "user123" } }
     * @principle Chat messages are publicly readable, and any signed-in user can create a message. Update and delete operations are restricted.
     */
    match /chat/{messageId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if false; // TODO: Add stricter rules.
        allow delete: if false; // TODO: Add stricter rules.
    }
  }
}