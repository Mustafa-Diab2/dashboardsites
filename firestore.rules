/**
 * @description
 * هذا الـ ruleset يفرض نموذج ملكية صارم لبيانات المستخدم وحضور الموظف والمهام،
 * مع إمكانية "أدمن" اختيارية عبر Custom Claims. يدعم مرفقات لكل مهمة (Firestore + Storage)،
 * ويعتمد على التحقق من ملكية الوثيقة لكل عملية قراءة/كتابة.
 *
 * @dataStructure
 *  - /users/{userId}:
 *      ملف المستخدم. المستخدم يقرأ/يكتب ملفه فقط (مع خيار list للمصادّقين لدعم القوائم).
 *  - /attendance/{attendanceId}:
 *      سجل الحضور. المستخدم يقرأ/ينشئ/يحدّث/يحذف سجلاته فقط.
 *  - /tasks/{taskId}:
 *      المهام. كل المصادّقين يقرأوا. الإنشاء/التحديث/الحذف لمالك المهمة (createdBy)،
 *      أو للأدمن (لو مفعّل claims).
 *  - /tasks/{taskId}/files/{fileId}:
 *      ميتاداتا المرفقات. القراءة للمصادّقين، والإنشاء/التعديل/الحذف للرافع فقط
 *      (أو للأدمن لو موجود).
 *
 * @keySecurityDecisions
 *  - users: ملكية ذاتية؛ (اختياري) السماح بالـ list للمصادّقين لدعم Dropdowns.
 *  - attendance: كل قراءة/استعلام يجب أن تكون لسجلات نفس المستخدم (userId == uid).
 *  - tasks: القراءة عامة للمصادّقين؛ الكتابة للـ createdBy أو للأدمن (claims).
 *  - files: الرافع فقط يدير ملفاته؛ القراءة عامة للمصادّقين.
 *
 * @denormalizationForAuthorization
 *  - لا نعتمد على get() داخل القواعد (لتكلفة الأداء)؛ إن لزم "أدمن"، نفضل Custom Claims:
 *    request.auth.token.role == "admin". (تُعيّن عبر Admin SDK).
 *
 * @structuralSegregation
 *  - لا يوجد فصل هيكلي إضافي.
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
     * Helper Functions
     * ============================ */
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // اختياري: دعم "أدمن" عبر Custom Claims (role = "admin")
    function isAdmin() {
      return isSignedIn() && (request.auth.token.role == "admin");
    }

    /* ============================
     * Users
     * ============================ */
    match /users/{userId} {
      allow get:   if isOwner(userId);
      allow list:  if isSignedIn(); // لو لا تحتاجه، اغلقه لزيادة الأمان
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isOwner(userId);
    }

    /* ============================
     * Attendance
     * ============================ */
    match /attendance/{attendanceId} {
      allow get:  if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    /* ============================
     * Clients
     * ============================ */
    match /clients/{clientId} {
      allow get:   if isSignedIn() && (resource.data.createdBy == request.auth.uid || isAdmin());
      allow list:  if isSignedIn() && isAdmin();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (resource.data.createdBy == request.auth.uid || isAdmin());
      allow delete: if isSignedIn() && (resource.data.createdBy == request.auth.uid || isAdmin());
    }

    /* ============================
     * Tasks
     * ============================ */
    match /tasks/{taskId} {
      allow read:   if isSignedIn(); // تغطي get + list
      allow create: if isSignedIn()
                    && request.resource.data.createdBy == request.auth.uid;

      allow update: if isSignedIn()
                    && (resource.data.createdBy == request.auth.uid || isAdmin());

      allow delete: if isSignedIn()
                    && (resource.data.createdBy == request.auth.uid || isAdmin());

      match /files/{fileId} {
        allow read:   if isSignedIn(); // تغطي get + list

        allow create: if isSignedIn()
                      && request.resource.data.uploadedBy == request.auth.uid
                      && request.resource.data.taskId == taskId;

        allow update: if isSignedIn()
                      && (resource.data.uploadedBy == request.auth.uid || isAdmin());

        allow delete: if isSignedIn()
                      && (resource.data.uploadedBy == request.auth.uid || isAdmin());
      }
    }

    /* ============================
     * Courses (اختياري—حسب نموذجك السابق)
     * ============================ */
    match /courses/{courseId} {
      allow read:   if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list:   if isSignedIn(); // ستفشل لأي وثيقة لا تخص نفس المستخدم
      allow create: if isSignedIn() && request.resource.data.userId != null;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
  }
}
