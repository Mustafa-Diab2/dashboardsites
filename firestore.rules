/**
 * Firestore Security Rules - النسخة النهائية المحسّنة
 *
 * نظام صلاحيات آمن ومرن يدعم:
 * - التحكم بالوصول حسب الدور (Role-Based Access Control)
 * - Custom Claims للأدمن
 * - فلترة البيانات حسب المستخدم
 *
 * Collections:
 * - /users: بيانات المستخدمين
 * - /attendance: سجلات الحضور والانصراف
 * - /tasks: المهام
 * - /tasks/{taskId}/files: مرفقات المهام
 * - /courses: الدورات التدريبية
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
     * Helper Functions - دوال مساعدة
     * ============================ */

    // التحقق من تسجيل الدخول
    function isSignedIn() {
      return request.auth != null;
    }

    // التحقق من ملكية المستخدم
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // التحقق من صلاحيات الأدمن (عبر Custom Claims)
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == "admin";
    }

    /* ============================
     * Users Collection
     * المستخدمون
     * ============================ */
    match /users/{userId} {
      // القراءة الفردية: المالك أو الأدمن
      allow get: if isOwner(userId) || isAdmin();

      // قراءة القائمة: أي مصادق (التطبيق يفلتر بـ where)
      // هذا ضروري لـ Dropdowns والفلاتر
      allow list: if isSignedIn();

      // الإنشاء: فقط للمالك
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;

      // التعديل: فقط للمالك (مع التأكد من عدم تغيير الـ id)
      allow update: if isOwner(userId) && resource.data.id == request.resource.data.id;

      // الحذف: فقط للمالك
      allow delete: if isOwner(userId);
    }

    /* ============================
     * Attendance Collection
     * سجلات الحضور والانصراف
     * ============================ */
    match /attendance/{attendanceId} {
      // القراءة الفردية: المالك أو الأدمن
      allow get: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());

      // قراءة القائمة: أي مصادق
      // التطبيق دائماً يستخدم where('userId', '==', uid) أو where() مع تواريخ
      allow list: if isSignedIn();

      // الإنشاء: فقط للمالك
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // التعديل: فقط للمالك أو الأدمن
      allow update: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());

      // الحذف: فقط للمالك أو الأدمن
      allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    /* ============================
     * Tasks Collection
     * المهام
     * ============================ */
    match /tasks/{taskId} {
      // القراءة: مفتوحة لكل المصادقين
      // Admin يرى كل المهام، المستخدمون يرون مهامهم (التطبيق يفلتر)
      allow read: if isSignedIn();

      // الإنشاء: فقط للمالك (createdBy)
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;

      // التعديل: المالك أو المُعيَّن أو الأدمن
      // المستخدم المُعيَّن (assigneeId) يحتاج تحديث حالة المهمة
      allow update: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        resource.data.assigneeId == request.auth.uid ||
        isAdmin()
      );

      // الحذف: المالك أو الأدمن
      allow delete: if isSignedIn() && (resource.data.createdBy == request.auth.uid || isAdmin());

      /* Files Subcollection - مرفقات المهام */
      match /files/{fileId} {
        // القراءة: كل المصادقين
        allow read: if isSignedIn();

        // الإنشاء: فقط للرافع (uploadedBy)
        allow create: if isSignedIn()
                      && request.resource.data.uploadedBy == request.auth.uid
                      && request.resource.data.taskId == taskId;

        // التعديل: الرافع أو الأدمن
        allow update: if isSignedIn()
                      && (resource.data.uploadedBy == request.auth.uid || isAdmin());

        // الحذف: الرافع أو الأدمن
        allow delete: if isSignedIn()
                      && (resource.data.uploadedBy == request.auth.uid || isAdmin());
      }
    }

    /* ============================
     * Courses Collection
     * الدورات التدريبية
     * ============================ */
    match /courses/{courseId} {
      // القراءة الفردية: المالك أو الأدمن
      allow get: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());

      // قراءة القائمة: أي مصادق
      // Admin: query() بدون where
      // User: query(where('userId', '==', uid))
      allow list: if isSignedIn();

      // الإنشاء: المالك أو الأدمن (الأدمن يمكنه إنشاء كورسات للآخرين)
      allow create: if isSignedIn() && (request.resource.data.userId == request.auth.uid || isAdmin());

      // التعديل: المالك أو الأدمن
      allow update: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());

      // الحذف: المالك أو الأدمن
      allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }
  }
}
