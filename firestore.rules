/**
 * @description This ruleset enforces a user-ownership model for user profiles and tasks,
 *              with public read access to tasks but restricted writes. Files are secured
 *              under their parent tasks.  It denormalizes user roles onto tasks to avoid
 *              `get()` calls in rules.
 * @dataStructure
 *   /users/{userId} - Stores user profiles (full name, role, creation timestamp).
 *   /tasks/{taskId} - Stores task details (title, description, assignee, status, etc.)
 *                      Includes a denormalized `userRole` field for efficient authorization.
 *   /tasks/{taskId}/files/{fileId} - Stores file metadata associated with tasks.
 * @keySecurityDecisions
 *   - Users can only list other `users` documents.
 *   - Tasks are publicly readable but writable only by authorized users (owner, assignee, or admin).
 *   - Files inherit the security context of their parent task.
 * @denormalizationForAuthorization
 *   - The `userRole` field is denormalized from the user's profile onto each task document
 *     to enable role-based access control without needing to perform `get()` calls in security rules.
 * @structuralSegregation
 *   - Public read access to tasks with owner-only or assignee-only writes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.  Users can only read their own profile; listing is denied.
     * @path /users/{userId}
     * @allow (get) Authenticated user can read their own profile.
     * @deny (get) Authenticated user cannot read another user's profile.
     * @allow (create) Authenticated user can create their own profile (self-registration).
     * @deny (create) Authenticated user cannot create another user's profile.
     * @allow (update) Authenticated user can update their own profile.
     * @deny (update) Authenticated user cannot update another user's profile.
     * @allow (delete) Authenticated user can delete their own profile.
     * @deny (delete) Authenticated user cannot delete another user's profile.
     * @principle Enforces document ownership and prevents unauthorized profile access.
     */
    match /users/{userId} {
      // Read rules
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;

      // Write rules
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isOwner(userId) && resource.data.id == userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to tasks.  Tasks are publicly readable, but writes are restricted to the owner, assignee, or an admin.
     * @path /tasks/{taskId}
     * @allow (get, list) Anyone can read tasks.
     * @allow (create) Authenticated user can create a task with their ID as the creator.
     * @deny (create) Task creation fails if the creator ID doesn't match the user's ID.
     * @allow (update) Authenticated user can update a task if they are the creator, assignee, or an admin (based on denormalized `userRole`).
     * @deny (update) Update fails if the user is not authorized.
     * @allow (delete) Authenticated user can delete a task if they are the creator.
     * @deny (delete) Delete fails if the user is not the creator.
     * @principle Enforces owner-only writes with public read access and requires explicit ownership validation on create.
     */
    match /tasks/{taskId} {
      // Read rules: Public read
      allow get: if true;
      allow list: if true;

      // Write rules: Restricted writes
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isSignedIn() && (isOwner(resource.data.createdBy) || isAssignee(resource.data.assigneeId) || isAdmin(resource.data.userRole)) && resource != null;
      allow delete: if isSignedIn() && isExistingOwner(resource.data.createdBy);
    }

    /**
     * @description Controls access to files associated with tasks.  Access is inherited from the parent task.
     * @path /tasks/{taskId}/files/{fileId}
     * @allow (get, list) Anyone can read files if they can read the parent task.
     * @allow (create) Authenticated user can create a file if they can write to the parent task.
     * @deny (create) File creation fails if the user is not authorized.
     * @allow (update) Authenticated user can update a file if they can write to the parent task.
     * @deny (update) Update fails if the user is not authorized.
     * @allow (delete) Authenticated user can delete a file if they can write to the parent task.
     * @deny (delete) Delete fails if the user is not authorized.
     * @principle Inherits security context from the parent task and enforces consistency between file and task ownership.
     */
    match /tasks/{taskId}/files/{fileId} {
      // Read rules: Inherit from task
      allow get: if true;
      allow list: if true;

      // Write rules: Inherit from task, validate taskId
      allow create: if isSignedIn() && get(/databases/$(database)/documents/tasks/$(taskId)).data.createdBy == request.auth.uid && request.resource.data.taskId == taskId;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/tasks/$(taskId)).data.createdBy == request.auth.uid && request.resource.data.taskId == taskId && resource != null;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/tasks/$(taskId)).data.createdBy == request.auth.uid && resource != null;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isSignedIn() && isOwner(userId) && resource != null;
  }

  function isAssignee(assigneeId) {
    return isSignedIn() && request.auth.uid == assigneeId;
  }

  function isAdmin(userRole) {
    return isSignedIn() && userRole == 'admin';
  }
}