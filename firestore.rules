/**
 * @description
 * Firestore Security Rules - نظام صلاحيات آمن وشامل
 *
 * هيكل البيانات:
 *  - /users/{userId}: بيانات المستخدمين
 *  - /attendance/{attendanceId}: سجلات الحضور
 *  - /tasks/{taskId}: المهام
 *  - /tasks/{taskId}/files/{fileId}: مرفقات المهام
 *  - /courses/{courseId}: الدورات التدريبية
 *
 * قرارات الأمان:
 *  - users: الأدمن فقط يرى القائمة الكاملة
 *  - attendance/courses: المستخدم يرى بياناته فقط (مع where clause)
 *  - tasks: الجميع يقرأ، المالك/الأدمن يكتب
 *
 * Custom Claims:
 *  - role: "admin" - يُعطى صلاحيات إضافية عبر Admin SDK
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
     * Helper Functions (Global)
     * ============================ */
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // دعم الأدمن عبر Custom Claims
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == "admin";
    }

    /* ============================
     * Users Collection
     * ============================ */
    match /users/{userId} {
      // القراءة الفردية: المالك أو الأدمن
      allow get:   if isOwner(userId) || isAdmin();

      // قراءة القائمة: الأدمن فقط، أو أي مصادق (لدعم Dropdowns مع where clause)
      // الكود يجب أن يستخدم where() للفلترة
      allow list:  if isSignedIn();

      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isOwner(userId);
    }

    /* ============================
     * Attendance Collection
     * ============================ */
    match /attendance/{attendanceId} {
      // القراءة الفردية: المالك أو الأدمن
      allow get:    if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());

      // قراءة القائمة: الكود يستخدم where('userId', '==', uid)
      allow list:   if isSignedIn();

      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /* ============================
     * Tasks Collection
     * ============================ */
    match /tasks/{taskId} {
      // القراءة: مفتوحة للجميع المصادقين
      allow read:   if isSignedIn();

      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isSignedIn() && (resource.data.createdBy == request.auth.uid || isAdmin());
      allow delete: if isSignedIn() && (resource.data.createdBy == request.auth.uid || isAdmin());

      /* Files Subcollection */
      match /files/{fileId} {
        allow read:   if isSignedIn();

        allow create: if isSignedIn()
                      && request.resource.data.uploadedBy == request.auth.uid
                      && request.resource.data.taskId == taskId;

        allow update: if isSignedIn()
                      && (resource.data.uploadedBy == request.auth.uid || isAdmin());

        allow delete: if isSignedIn()
                      && (resource.data.uploadedBy == request.auth.uid || isAdmin());
      }
    }

    /* ============================
     * Courses Collection
     * ============================ */
    match /courses/{courseId} {
      // القراءة الفردية: المالك أو الأدمن
      allow get:    if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());

      // قراءة القائمة: الكود يستخدم where('userId', '==', uid)
      allow list:   if isSignedIn();

      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
  }
}
